<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>周易卜卦系统 - 增强版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://sf16-scmcdn-sg.ibytedtos.com">
    <link rel="stylesheet"
        href="https://sf16-scmcdn-sg.ibytedtos.com/goofy/ee/lark/external_pkg/_next/static/css/719d525e8e3a7d4e.css">
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f1f2f6;
            background-image: linear-gradient(to top, #d2d8e0 0%, #a4b0be 100%);
        }

        h1,
        h2,
        h3,
        .font-serif {
            font-family: 'Noto Serif SC', serif;
        }

        /* Coin flipping animation */
        .coin-container {
            perspective: 1000px;
        }

        .coin {
            width: 80px;
            height: 80px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1s;
        }

        .coin-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        .coin-front {
            background: radial-gradient(circle, #f9f0da, #e7d9b7);
            color: #8B5A2B;
            border: 3px solid #c8a876;
            transform: rotateY(0deg);
        }

        .coin-back {
            background: radial-gradient(circle, #e0e0e0, #b0b0b0);
            color: #4a4a4a;
            border: 3px solid #9a9a9a;
            transform: rotateY(180deg);
        }

        .coin.is-flipping {
            transform: rotateY(1800deg);
        }

        /* Yao (line) styles */
        .yao.yin::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20%;
            height: 100%;
            background-color: #f1f2f6;
            transform: translate(-50%, -50%);
        }

        .yao.changing::before {
            content: "●";
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            color: #c0392b;
        }

        /* Modal styles */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>

<body class="text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8 p-6 bg-white/70 backdrop-blur-sm rounded-xl shadow-lg">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">周易卜卦</h1>
            <p class="text-lg text-gray-600 mt-2">探索古代智慧，寻求内心答案</p>
        </header>

        <main id="main-content" class="bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-6 md:p-8">

            <div id="divination-section">
                <div class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-3">第一步：诚心发问</h2>
                    <input type="text" id="question" placeholder="在此记录您的问题（选填）"
                        class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>

                <div class="text-center">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6">第二步：掷爻成卦</h2>

                    <div class="flex justify-center items-center space-x-6 mb-8">
                        <div class="coin-container">
                            <div class="coin" id="coin1">
                                <div class="coin-face coin-front">阳</div>
                                <div class="coin-face coin-back">阴</div>
                            </div>
                        </div>
                        <div class="coin-container">
                            <div class="coin" id="coin2">
                                <div class="coin-face coin-front">阳</div>
                                <div class="coin-face coin-back">阴</div>
                            </div>
                        </div>
                        <div class="coin-container">
                            <div class="coin" id="coin3">
                                <div class="coin-face coin-front">阳</div>
                                <div class="coin-face coin-back">阴</div>
                            </div>
                        </div>
                    </div>

                    <button id="toss-button"
                        class="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                        开始掷爻 (1/6)
                    </button>

                    <div class="mt-8 max-w-xs mx-auto">
                        <h3 class="text-xl font-semibold text-gray-600 mb-4">卦象构成</h3>
                        <div class="space-y-2" id="yao-container">
                        </div>
                    </div>
                </div>
            </div>

            <div id="result-section" class="hidden">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">卦象结果</h2>

                <div
                    class="flex flex-col md:flex-row justify-center items-center gap-8 md:gap-12 mb-8 p-6 bg-gray-50 rounded-lg">
                    <div class="text-center">
                        <div id="hexagram-image"
                            class="w-24 mx-auto space-y-1.5 space-y-reverse mb-2 flex flex-col-reverse"></div>
                        <h3 id="hexagram-name" class="text-xl font-semibold text-gray-700"></h3>
                        <p id="hexagram-code" class="text-sm text-gray-500"></p>
                    </div>

                    <div id="arrow-container" class="hidden text-3xl text-blue-500 font-bold">→</div>

                    <div id="hexagram-changing-section" class="hidden text-center">
                        <div id="hexagram-changing-image"
                            class="w-24 mx-auto space-y-1.5 space-y-reverse mb-2 flex flex-col-reverse"></div>
                        <h3 id="hexagram-changing-name" class="text-xl font-semibold text-gray-700"></h3>
                        <p id="hexagram-changing-code" class="text-sm text-gray-500"></p>
                    </div>
                </div>

                <div>
                    <div class="border-b border-gray-200">
                        <nav id="tabs-container" class="-mb-px flex space-x-6" aria-label="Tabs">
                        </nav>
                    </div>
                    <div id="tab-content" class="mt-6">
                    </div>
                </div>

                <div class="text-center mt-8">
                    <button id="new-divination"
                        class="px-8 py-3 bg-gray-700 text-white font-bold rounded-lg shadow-md hover:bg-gray-800 transition-all duration-300 transform hover:scale-105">
                        重新卜卦
                    </button>
                </div>
            </div>

        </main>

        <div class="absolute top-4 right-4 md:top-8 md:right-8">
            <button id="history-button"
                class="flex items-center px-4 py-2 bg-white/70 text-gray-700 rounded-lg shadow-md hover:bg-white transition-colors duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="w-5 h-5 mr-2">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                    <path d="M12 8v4l2 2"></path>
                </svg>
                历史记录
            </button>
        </div>

    </div>

    <div id="history-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 opacity-0 invisible">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-11/12 max-w-2xl transform scale-95">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">卜卦历史</h2>
                <button id="close-modal-button" class="text-gray-400 hover:text-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="w-6 h-6">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div id="history-list" class="p-6 max-h-[60vh] overflow-y-auto">
            </div>
            <div class="p-6 bg-gray-50 rounded-b-xl text-right">
                <button id="clear-history-button"
                    class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition disabled:bg-gray-300">
                    清空历史
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Data and constants
        const bagua = { names: ["乾", "兑", "离", "震", "巽", "坎", "艮", "坤"], attributes: ["天", "泽", "火", "雷", "风", "水", "山", "地"], codes: [[1, 1, 1], [1, 1, 0], [1, 0, 1], [1, 0, 0], [0, 1, 1], [0, 1, 0], [0, 0, 1], [0, 0, 0]] };

        // --- hexagrams data is omitted as requested ---
        // 重要提示：您需要在此处提供一个完整且正确的 hexagrams 数组。
        // The original data in the file was corrupted, leading to lookup errors.
        const hexagrams = [
            {
                "id": 1,
                "name": "乾",
                "alias": "乾为天",
                "gua": [1, 1, 1, 1, 1, 1],
                "description": "元亨利贞。",
                "overall": "乾卦代表纯阳刚健之象，表示事物处于强盛发展的阶段。",
                "details": "乾卦象征天，具有刚健、自强不息的特性。六爻皆阳，表示充满活力与创造力，适合开展事业和进取。但需警惕过于刚强可能导致的亢龙有悔。",
                "lines": [
                    "初九：潜龙勿用。",
                    "九二：见龙在田，利见大人。",
                    "九三：君子终日乾乾，夕惕若厉，无咎。",
                    "九四：或跃在渊，无咎。",
                    "九五：飞龙在天，利见大人。",
                    "上九：亢龙有悔。"
                ]
            },
            {
                "id": 2,
                "name": "坤",
                "alias": "坤为地",
                "gua": [0, 0, 0, 0, 0, 0],
                "description": "元亨，利牝马之贞。君子有攸往，先迷后得主，利。西南得朋，东北丧朋。安贞吉。",
                "overall": "坤卦代表纯阴柔顺之象，表示事物处于包容、承载和发展的阶段。",
                "details": "坤卦象征地，具有柔顺、宽厚、承载万物的特性。六爻皆阴，表示极其柔顺，能够容纳和滋养万物。在事业和生活中，宜采取柔和、辅助的策略，以退为进，厚德载物。警惕过于被动而失去主导。",
                "lines": [
                    "初六：履霜，坚冰至。",
                    "六二：直、方、大，不习无不利。",
                    "六三：含章可贞。或从王事，无成有终。",
                    "六四：括囊，无咎无誉。",
                    "六五：黄裳，元吉。",
                    "上六：龙战于野，其血玄黄。"
                ]
            },
            {
                "id": 3,
                "name": "屯",
                "alias": "水雷屯",
                "gua": [1, 0, 0, 0, 1, 0],
                "description": "元亨利贞，勿用有攸往，利建侯。",
                "overall": "屯卦象征事物初生时的艰难，表示万事开头难，需要耐心和积累。",
                "details": "屯卦上坎下震，水在雷上，是创始的艰难时期。虽然前景光明（元亨利贞），但不宜贸然前进（勿用有攸往）。此时最重要的是稳固根基，积聚力量，如同建立根基，为将来的发展做准备。",
                "lines": [
                    "初九：磐桓，利居贞，利建侯。",
                    "六二：屯如邅如，乘马班如。匪寇婚媾，女子贞不字，十年乃字。",
                    "六三：即鹿无虞，惟入于林中。君子几，不如舍，往吝。",
                    "六四：乘马班如，求婚媾，往吉，无不利。",
                    "九五：屯其膏，小贞吉，大贞凶。",
                    "上六：乘马班如，泣血涟如。"
                ]
            },
            {
                "id": 4,
                "name": "蒙",
                "alias": "山水蒙",
                "gua": [0, 1, 0, 0, 0, 1],
                "description": "亨。匪我求童蒙，童蒙求我。初筮告，再三渎，渎则不告。利贞。",
                "overall": "蒙卦象征启蒙和教育，表示事物处于蒙昧状态，需要正确的引导。",
                "details": "蒙卦上艮下坎，山下有险泉，象征蒙昧。此时并非自己主动去教育蒙昧的人，而是等待对方虚心求教。对于初次真心求教的，应予以指导；但如果反复试探、态度轻慢，则不应再告知。利于守正以待时机。",
                "lines": [
                    "初六：发蒙，利用刑人，用说桎梏，以往吝。",
                    "九二：包蒙吉，纳妇吉，子克家。",
                    "六三：勿用取女，见金夫，不有躬，无攸利。",
                    "六四：困蒙，吝。",
                    "六五：童蒙，吉。",
                    "上九：击蒙，不利为寇，利御寇。"
                ]
            },
            {
                "id": 5,
                "name": "需",
                "alias": "水天需",
                "gua": [1, 1, 1, 0, 1, 0],
                "description": "有孚，光亨，贞吉。利涉大川。",
                "overall": "需卦象征等待和期望，表示时机未到，需要耐心等待。",
                "details": "需卦上坎下乾，天在水下，表示虽然有实力（乾），但前有险阻（坎），必须等待。只要心怀诚信（有孚），前途就会光明亨通（光亨），坚守正道可获吉祥（贞吉）。利于渡过大河，比喻可以克服大的艰难险阻。",
                "lines": [
                    "初九：需于郊，利用恒，无咎。",
                    "九二：需于沙，小有言，终吉。",
                    "九三：需于泥，致寇至。",
                    "六四：需于血，出自穴。",
                    "九五：需于酒食，贞吉。",
                    "上六：入于穴，有不速之客三人来，敬之终吉。"
                ]
            },
            {
                "id": 6,
                "name": "讼",
                "alias": "天水讼",
                "gua": [0, 1, 0, 1, 1, 1],
                "description": "有孚，窒惕，中吉，终凶。利见大人，不利涉大川。",
                "overall": "讼卦象征争讼和冲突，表示有诚信也会有阻塞和危险。",
                "details": "讼卦上乾下坎，天在上水在下，象征意志与险难相遇，容易产生争端。虽然心怀诚信，但过程中充满阻塞和警惕。事情进行到一半或许吉祥，但坚持到底则有凶险。利于求见有德的“大人”来调解，不利于冒险犯难。",
                "lines": [
                    "初六：不永所事，小有言，终吉。",
                    "九二：不克讼，归而逋，其邑人三百户，无眚。",
                    "六三：食旧德，贞厉，终吉。或从王事，无成。",
                    "九四：不克讼，复即命，渝安贞，吉。",
                    "九五：讼，元吉。",
                    "上九：或锡之鞶带，终朝三褫之。"
                ]
            },
            {
                "id": 7,
                "name": "师",
                "alias": "地水师",
                "gua": [0, 1, 0, 0, 0, 0],
                "description": "贞，丈人吉，无咎。",
                "overall": "师卦象征军队和战争，引申为需要有纪律、有组织的行动。",
                "details": "师卦上坤下坎，地下藏水，象征着民众之中蕴含着巨大的力量，如同军队。此卦强调行动必须出于正义（贞），并且需要有经验、有德行的长者（丈人）来领导，才能获得吉祥，没有灾祸。",
                "lines": [
                    "初六：师出以律，否臧凶。",
                    "九二：在师中，吉，无咎，王三锡命。",
                    "六三：师或舆尸，凶。",
                    "六四：师左次，无咎。",
                    "六五：田有禽，利执言，无咎。长子帅师，弟子舆尸，贞凶。",
                    "上六：大君有命，开国承家，小人勿用。"
                ]
            },
            {
                "id": 8,
                "name": "比",
                "alias": "水地比",
                "gua": [0, 0, 0, 0, 1, 0],
                "description": "吉。原筮，元永贞，无咎。不宁方来，后夫凶。",
                "overall": "比卦象征亲近和辅助，表示团结协作的重要性。",
                "details": "比卦上坎下坤，水行地上，象征着互相亲附、辅助。此卦为吉利之卦。但要求在建立关系之初就要审慎，要寻求有长远、正固德行的人作为核心，这样才没有灾祸。天下不安定的邦国都会前来归附，但迟疑不决、最后才来的人将有凶险。",
                "lines": [
                    "初六：有孚比之，无咎。有孚盈缶，终来有他吉。",
                    "六二：比之自内，贞吉。",
                    "六三：比之匪人。",
                    "六四：外比之，贞吉。",
                    "九五：显比，王用三驱，失前禽，邑人不诫，吉。",
                    "上六：比之无首，凶。"
                ]
            },
            {
                "id": 9,
                "name": "小畜",
                "alias": "风天小畜",
                "gua": [1, 1, 1, 0, 1, 1],
                "description": "亨。密云不雨，自我西郊。",
                "overall": "小畜卦象征小的积蓄和小的阻碍，表示力量尚小，需要等待时机。",
                "details": "小畜卦上巽下乾，风行天上。风的力量虽然能聚集云层，但还不足以致雨，象征着虽然有亨通的趋势，但受到小的牵制，时机尚未成熟。如同西郊上空乌云密布，但雨还没有下来，需要耐心等待。",
                "lines": [
                    "初九：复自道，何其咎，吉。",
                    "九二：牵复，吉。",
                    "九三：舆说辐，夫妻反目。",
                    "六四：有孚，血去惕出，无咎。",
                    "九五：有孚挛如，富以其邻。",
                    "上九：既雨既处，尚德载，妇贞厉。月几望，君子征凶。"
                ]
            },
            {
                "id": 10,
                "name": "履",
                "alias": "天泽履",
                "gua": [1, 1, 0, 1, 1, 1],
                "description": "履虎尾，不咥人，亨。",
                "overall": "履卦象征履行和实践，表示行为需谨慎，但前景亨通。",
                "details": "履卦上乾下兑，天在泽上，象征着行走在充满喜悦和风险的道路上。如同踩着老虎的尾巴，但老虎却没有咬人，表示虽然有危险，但只要行为得当、心怀敬畏，最终能够亨通。",
                "lines": [
                    "初九：素履，往无咎。",
                    "九二：履道坦坦，幽人贞吉。",
                    "六三：眇能视，跛能履，履虎尾，咥人，凶。武人为于大君。",
                    "九四：履虎尾，愬愬，终吉。",
                    "九五：夬履，贞厉。",
                    "上九：视履考祥，其旋元吉。"
                ]
            },
            {
                "id": 11,
                "name": "泰",
                "alias": "地天泰",
                "gua": [1, 1, 1, 0, 0, 0],
                "description": "小往大来，吉，亨。",
                "overall": "泰卦象征通达和安泰，是吉利亨通的卦。",
                "details": "泰卦上坤下乾，地气上升，天气下降，阴阳交合，万物通畅。象征着小的离去，大的到来，是国家安泰、个人事业顺利的时期。此时应抓住机遇，顺势而为。",
                "lines": [
                    "初九：拔茅茹，以其汇，征吉。",
                    "九二：包荒，用冯河，不遐遗，朋亡，得尚于中行。",
                    "九三：无平不陂，无往不复，艰贞无咎。勿恤其孚，于食有福。",
                    "六四：翩翩不富，以其邻，不戒以孚。",
                    "六五：帝乙归妹，以祉元吉。",
                    "上六：城复于隍，勿用师。自邑告命，贞吝。"
                ]
            },
            {
                "id": 12,
                "name": "否",
                "alias": "天地否",
                "gua": [0, 0, 0, 1, 1, 1],
                "description": "否之匪人，不利君子贞，大往小来。",
                "overall": "否卦象征闭塞和阻滞，是不吉利的卦。",
                "details": "否卦上乾下坤，天气上升，地气下沉，阴阳不交，万物不通。象征着闭塞不通的时期，对于君子来说是不利的。此时大的离去，小的到来，是小人得志、君子困顿的时期。应隐忍待机，坚守正道。",
                "lines": [
                    "初六：拔茅茹，以其汇，贞吉，亨。",
                    "六二：包承，小人吉，大人否亨。",
                    "六三：包羞。",
                    "九四：有命无咎，畴离祉。",
                    "九五：休否，大人吉。其亡其亡，系于苞桑。",
                    "上九：倾否，先否后喜。"
                ]
            },
            {
                "id": 13,
                "name": "同人",
                "alias": "天火同人",
                "gua": [1, 0, 1, 1, 1, 1],
                "description": "同人于野，亨。利涉大川，利君子贞。",
                "overall": "同人卦象征与人和同，表示团结合作，共同前进。",
                "details": "同人卦上乾下离，天与火的组合，光明正大，象征着在广阔的天地间与人和睦相处。此时利于团结众人，共同渡过难关，成就大业。君子应坚守正道，以德服人。",
                "lines": [
                    "初九：同人于门，无咎。",
                    "六二：同人于宗，吝。",
                    "九三：伏戎于莽，升其高陵，三岁不兴。",
                    "九四：乘其墉，弗克攻，吉。",
                    "九五：同人，先号啕而后笑，大师克相遇。",
                    "上九：同人于郊，无悔。"
                ]
            },
            {
                "id": 14,
                "name": "大有",
                "alias": "火天大有",
                "gua": [1, 1, 1, 1, 0, 1],
                "description": "元亨。",
                "overall": "大有卦象征大的拥有和丰收，是极为亨通的卦。",
                "details": "大有卦上离下乾，火在天上，光明普照，象征着伟大的功业和巨大的财富。唯一的阴爻（六五）处于君位，象征柔顺中正的君主，能够吸引众阳爻的归附。此时应顺应天道，抑恶扬善，以保长久。",
                "lines": [
                    "初九：无交害，匪咎，艰则无咎。",
                    "九二：大车以载，有攸往，无咎。",
                    "九三：公用亨于天子，小人弗克。",
                    "九四：匪其彭，无咎。",
                    "六五：厥孚交如，威如，吉。",
                    "上九：自天祐之，吉无不利。"
                ]
            },
            {
                "id": 15,
                "name": "谦",
                "alias": "地山谦",
                "gua": [0, 0, 1, 0, 0, 0],
                "description": "亨，君子有终。",
                "overall": "谦卦象征谦虚和退让，是亨通的卦。",
                "details": "谦卦上坤下艮，高山隐藏于地下，象征着有才有德却甘居人下，非常谦虚。谦虚是一种美德，能够使万事亨通，君子若能保持谦虚，必能有好的结局。此卦是六十四卦中唯一六爻皆吉的卦。",
                "lines": [
                    "初六：谦谦君子，用涉大川，吉。",
                    "六二：鸣谦，贞吉。",
                    "九三：劳谦君子，有终，吉。",
                    "六四：无不利，捄谦。",
                    "六五：不富以其邻，利用侵伐，无不利。",
                    "上六：鸣谦，利用行师，征邑国。"
                ]
            },
            {
                "id": 16,
                "name": "豫",
                "alias": "雷地豫",
                "gua": [0, 0, 0, 0, 1, 0],
                "description": "利建侯行师。",
                "overall": "豫卦象征愉悦和顺从，表示因顺从而得愉悦。",
                "details": "豫卦上震下坤，雷生于地，万物复苏，象征着愉悦和喜悦。唯一的阳爻（九四）得到众阴爻的顺从，所以能够安乐。此时利于建立功业、出兵征伐，因为顺应时势，能得到大家的支持。",
                "lines": [
                    "初六：鸣豫，凶。",
                    "六二：介于石，不终日，贞吉。",
                    "六三：盱豫，悔。迟有悔。",
                    "九四：由豫，大有得。勿疑，朋盍簪。",
                    "六五：贞疾，恒不死。",
                    "上六：冥豫，成有渝，无咎。"
                ]
            },
            {
                "id": 17,
                "name": "随",
                "alias": "泽雷随",
                "gua": [1, 0, 0, 1, 1, 0],
                "description": "元亨利贞，无咎。",
                "overall": "随卦象征随从和顺应，表示顺应时势而动。",
                "details": "随卦上兑下震，泽中有雷，象征着随时而动。此时若能顺应时势和他人的意愿，便能大亨通，利于坚守正道，没有灾祸。但随从不是盲从，要有自己的原则和判断。",
                "lines": [
                    "初九：官有渝，贞吉。出门交有功。",
                    "六二：系小子，失丈夫。",
                    "六三：系丈夫，失小子。随有求得，利居贞。",
                    "九四：随有获，贞凶。有孚在道，以明，何咎。",
                    "九五：孚于嘉，吉。",
                    "上六：拘系之，乃从维之。王用亨于西山。"
                ]
            },
            {
                "id": 18,
                "name": "蛊",
                "alias": "山风蛊",
                "gua": [0, 1, 1, 0, 0, 1],
                "description": "元亨，利涉大川。先甲三日，后甲三日。",
                "overall": "蛊卦象征整治和革新，表示事物败坏之后需要大力整顿。",
                "details": "蛊卦上艮下巽，山下有风，象征事物停滞不动而腐败生虫。此时是拨乱反正、进行改革的良机，能够大亨通。利于冒险犯难。在行动之前需要周密计划，行动之后也要妥善处理后续事宜。",
                "lines": [
                    "初六：干父之蛊，有子，考无咎，厉终吉。",
                    "九二：干母之蛊，不可贞。",
                    "九三：干父之蛊，小有悔，无大咎。",
                    "六四：裕父之蛊，往见吝。",
                    "六五：干父之蛊，用誉。",
                    "上九：不事王侯，高尚其事。"
                ]
            },
            {
                "id": 19,
                "name": "临",
                "alias": "地泽临",
                "gua": [1, 1, 0, 0, 0, 0],
                "description": "元亨利贞。至于八月有凶。",
                "overall": "临卦象征君临和治理，表示阳气增长，形势大好。",
                "details": "临卦上坤下兑，地在泽上，象征着居高临下，进行治理。阳气逐渐增长，形势一片大好，大亨通，利于坚守正道。但盛极必衰，到了八月（象征阴气增长时），就会有凶险，需要保持警惕。",
                "lines": [
                    "初九：咸临，贞吉。",
                    "九二：咸临，吉，无不利。",
                    "六三：甘临，无攸利。既忧之，无咎。",
                    "六四：至临，无咎。",
                    "六五：知临，大君之宜，吉。",
                    "上六：敦临，吉，无咎。"
                ]
            },
            {
                "id": 20,
                "name": "观",
                "alias": "风地观",
                "gua": [0, 0, 0, 0, 1, 1],
                "description": "盥而不荐，有孚顒若。",
                "overall": "观卦象征观察和瞻仰，表示以德化人。",
                "details": "观卦上巽下坤，风行地上，象征着君王的德教遍行四方，民众都来瞻仰。如同举行祭祀时，盥洗双手以示虔诚，但还未献上祭品，此时内心充满诚信和敬仰。治国者应以身作则，展现德行，民众自会信服。",
                "lines": [
                    "初六：童观，小人无咎，君子吝。",
                    "六二：窥观，利女贞。",
                    "六三：观我生，进退。",
                    "六四：观国之光，利用宾于王。",
                    "九五：观我生，君子无咎。",
                    "上九：观其生，君子无咎。"
                ]
            },
            {
                "id": 21,
                "name": "噬嗑",
                "alias": "火雷噬嗑",
                "gua": [1, 0, 0, 1, 0, 1],
                "description": "亨，利用狱。",
                "overall": "噬嗑卦象征咬合和刑罚，表示要用强硬手段解决问题。",
                "details": "噬嗑卦上离下震，火与雷的组合，象征着光明与威严。如同口中之物，需要用力咬合才能吃下。比喻社会中出现了障碍，需要使用刑罚、法律等强硬手段来治理，才能亨通。",
                "lines": [
                    "初九：屦校灭趾，无咎。",
                    "六二：噬肤灭鼻，无咎。",
                    "六三：噬腊肉，遇毒。小吝，无咎。",
                    "九四：噬干胏，得金矢，利艰贞，吉。",
                    "六五：噬干肉，得黄金，贞厉，无咎。",
                    "上九：何校灭耳，凶。"
                ]
            },
            {
                "id": 22,
                "name": "贲",
                "alias": "山火贲",
                "gua": [1, 0, 1, 0, 0, 1],
                "description": "亨。小利有攸往。",
                "overall": "贲卦象征装饰和文饰，表示事物需要适当的修饰。",
                "details": "贲卦上艮下离，山下有火，照亮山景，使其变得美丽。象征着对事物进行文饰和修饰。此时亨通，小的方面可以有所作为。但装饰应适度，不可过分，内在的实质才是最重要的。",
                "lines": [
                    "初九：贲其趾，舍车而徒。",
                    "六二：贲其须。",
                    "九三：贲如濡如，永贞吉。",
                    "六四：贲如皤如，白马翰如，匪寇婚媾。",
                    "六五：贲于丘园，束帛戋戋，吝，终吉。",
                    "上九：白贲，无咎。"
                ]
            },
            {
                "id": 23,
                "name": "剥",
                "alias": "山地剥",
                "gua": [0, 0, 0, 0, 0, 1],
                "description": "不利有攸往。",
                "overall": "剥卦象征剥落和侵蚀，表示小人得势，君子受损。",
                "details": "剥卦上艮下坤，高山附着于大地，但山石却在不断剥落。群阴爻从下向上侵蚀唯一的阳爻，象征着小人势力猖獗，君子之道受到严重损害。此时不利于有任何行动，应顺时而止，静待时机转变。",
                "lines": [
                    "初六：剥床以足，蔑贞凶。",
                    "六二：剥床以辨，蔑贞凶。",
                    "六三：剥之，无咎。",
                    "六四：剥床以肤，凶。",
                    "六五：贯鱼，以宫人宠，无不利。",
                    "上九：硕果不食，君子得舆，小人剥庐。"
                ]
            },
            {
                "id": 24,
                "name": "复",
                "alias": "地雷复",
                "gua": [1, 0, 0, 0, 0, 0],
                "description": "亨。出入无疾，朋来无咎。反复其道，七日来复，利有攸往。",
                "overall": "复卦象征回复和复苏，表示阳气回归，万物重生。",
                "details": "复卦上坤下震，大地之下雷声初动，阳气开始回归。象征着恶运过去，善道回归，亨通。此时出入没有障碍，朋友前来相助也没有灾祸。事物的发展有其周期，经过七个阶段就会迎来新的开始。利于前行。",
                "lines": [
                    "初九：不远复，无祗悔，元吉。",
                    "六二：休复，吉。",
                    "六三：频复，厉，无咎。",
                    "六四：中行独复。",
                    "六五：敦复，无悔。",
                    "上六：迷复，凶，有灾眚。用行师，终有大败，以其国君凶，至于十年不克征。"
                ]
            },
            {
                "id": 25,
                "name": "无妄",
                "alias": "天雷无妄",
                "gua": [1, 0, 0, 1, 1, 1],
                "description": "元亨利贞。其匪正有眚，不利有攸往。",
                "overall": "无妄卦象征真实无妄，不存虚假。",
                "details": "无妄卦上乾下震，天下雷动，象征着一切出于自然，不可妄为。只要坚守正道，就能大亨通。但如果行为不正，就会有灾祸，不利于前行。强调要顺应天道，保持纯真本性。",
                "lines": [
                    "初九：无妄，往吉。",
                    "六二：不耕获，不菑畬，则利有攸往。",
                    "六三：无妄之灾，或系之牛，行人之得，邑人之灾。",
                    "九四：可贞，无咎。",
                    "九五：无妄之疾，勿药有喜。",
                    "上九：无妄，行有眚，无攸利。"
                ]
            },
            {
                "id": 26,
                "name": "大畜",
                "alias": "山天大畜",
                "gua": [1, 1, 1, 0, 0, 1],
                "description": "利贞，不家食吉，利涉大川。",
                "overall": "大畜卦象征大的积蓄和蕴藏，表示积蓄力量，待时而动。",
                "details": "大畜卦上艮下乾，山中有天，象征着蕴藏着巨大的能量。此时利于坚守正道，不满足于在家里享福，而是放眼天下，担当大任，这样才能吉祥。利于冒险犯难，成就大业。",
                "lines": [
                    "初九：有厉，利已。",
                    "九二：舆说辐。",
                    "九三：良马逐，利艰贞。日闲舆卫，利有攸往。",
                    "六四：童牛之牿，元吉。",
                    "六五：豶豕之牙，吉。",
                    "上九：何天之衢，亨。"
                ]
            },
            {
                "id": 27,
                "name": "颐",
                "alias": "山雷颐",
                "gua": [1, 0, 0, 0, 0, 1],
                "description": "贞吉。观颐，自求口实。",
                "overall": "颐卦象征颐养和养育，表示要注意言语和饮食。",
                "details": "颐卦上下皆为阳爻，中间四阴爻，形如口腔，象征颐养。坚守正道可获吉祥。要观察颐养之道，关键在于自力更生，寻求正当的食物来养活自己，也指修养品德，谨言慎行。",
                "lines": [
                    "初九：舍尔灵龟，观我朵颐，凶。",
                    "六二：颠颐，拂经，于丘颐，征凶。",
                    "六三：拂颐，贞凶，十年勿用，无攸利。",
                    "六四：颠颐，吉。虎视眈眈，其欲逐逐，无咎。",
                    "六五：拂经，居贞吉，不可涉大川。",
                    "上九：由颐，厉吉，利涉大川。"
                ]
            },
            {
                "id": 28,
                "name": "大过",
                "alias": "泽风大过",
                "gua": [0, 1, 1, 1, 1, 0],
                "description": "栋桡，利有攸往，亨。",
                "overall": "大过卦象征大的过渡和非常时期。",
                "details": "大过卦四阳爻在内，二阴爻在外，阳气过盛，如同房屋的栋梁已经弯曲，处于非常危险的时期。但这也是采取非常行动、建立非常功业的时机，所以利于前行，能够亨通。",
                "lines": [
                    "初六：藉用白茅，无咎。",
                    "九二：枯杨生稊，老夫得其女妻，无不利。",
                    "九三：栋桡，凶。",
                    "九四：栋隆，吉。有它吝。",
                    "九五：枯杨生华，老妇得其士夫，无咎无誉。",
                    "上六：过涉灭顶，凶，无咎。"
                ]
            },
            {
                "id": 29,
                "name": "坎",
                "alias": "坎为水",
                "gua": [0, 1, 0, 0, 1, 0],
                "description": "习坎，有孚，维心亨，行有尚。",
                "overall": "坎卦象征重重险难，表示身陷险境。",
                "details": "坎卦上下皆为坎，是重重险难之象。此时最重要的是保持内心的诚信（有孚），这样才能在险难中获得亨通。行动也会得到赞赏。在困境中，信心和智慧是走出险境的关键。",
                "lines": [
                    "初六：习坎，入于坎窞，凶。",
                    "九二：坎有险，求小得。",
                    "六三：来之坎坎，险且枕，入于坎窞，勿用。",
                    "六四：樽酒簋贰，用缶，纳约自牖，终无咎。",
                    "九五：坎不盈，祗既平，无咎。",
                    "上六：系用徽纆，置于丛棘，三岁不得，凶。"
                ]
            },
            {
                "id": 30,
                "name": "离",
                "alias": "离为火",
                "gua": [1, 0, 1, 1, 0, 1],
                "description": "利贞，亨。畜牝牛，吉。",
                "overall": "离卦象征光明和附丽，表示依附于正道。",
                "details": "离卦上下皆为离，象征着光明和美丽。利于坚守正道，才能亨通。如同畜养柔顺的母牛一样，能够获得吉祥。此卦强调要像太阳一样，依附于天空而普照万物，人也要依附于正道，才能发挥自己的才能。",
                "lines": [
                    "初九：履错然，敬之，无咎。",
                    "六二：黄离，元吉。",
                    "九三：日昃之离，不鼓缶而歌，则大耋之嗟，凶。",
                    "九四：突如其来如，焚如，死如，弃如。",
                    "六五：出涕沱若，戚嗟若，吉。",
                    "上九：王用出征，有嘉折首，获匪其丑，无咎。"
                ]
            },
            {
                "id": 31,
                "name": "咸",
                "alias": "泽山咸",
                "gua": [0, 0, 1, 1, 1, 0],
                "description": "亨，利贞，取女吉。",
                "overall": "咸卦象征感应，表示男女互相爱慕，万物相互感应。",
                "details": "咸卦上兑下艮，少女与少男的组合，是阴阳感应最纯正的象征。因此亨通，利于坚守正道。娶妻吉祥。此卦强调人与人之间、人与物之间的真诚感应，是成就事业的基础。",
                "lines": [
                    "初六：咸其拇。",
                    "六二：咸其腓，凶，居吉。",
                    "九三：咸其股，执其随，往吝。",
                    "九四：贞吉悔亡，憧憧往来，朋从尔思。",
                    "九五：咸其脢，无悔。",
                    "上六：咸其辅颊舌。"
                ]
            },
            {
                "id": 32,
                "name": "恒",
                "alias": "雷风恒",
                "gua": [0, 1, 1, 1, 0, 0],
                "description": "亨，无咎，利贞，利有攸往。",
                "overall": "恒卦象征恒久，表示要持之以恒。",
                "details": "恒卦上震下巽，长男与长女的组合，象征夫妻之道能够长久。此卦亨通，没有灾祸，利于坚守正道，利于前行。成功之道在于坚持不懈，保持恒心。",
                "lines": [
                    "初六：浚恒，贞凶，无攸利。",
                    "九二：悔亡。",
                    "九三：不恒其德，或承之羞，贞吝。",
                    "九四：田无禽。",
                    "六五：恒其德，贞，妇人吉，夫子凶。",
                    "上六：振恒，凶。"
                ]
            },
            {
                "id": 33,
                "name": "遁",
                "alias": "天山遁",
                "gua": [0, 0, 1, 1, 1, 1],
                "description": "亨，小利贞。",
                "overall": "遁卦象征退避，表示应主动退让以避开危险。",
                "details": "遁卦上乾下艮，天下有山，象征着隐退。阴爻在下逐渐增长，阳爻应主动退避。此时亨通，小的方面利于坚守正道。退避不是消极逃跑，而是为了保全实力，待机而动，是一种智慧。",
                "lines": [
                    "初六：遁尾，厉，勿用有攸往。",
                    "六二：执之用黄牛之革，莫之胜说。",
                    "九三：系遁，有疾厉，畜臣妾吉。",
                    "九四：好遁，君子吉，小人否。",
                    "九五：嘉遁，贞吉。",
                    "上九：肥遁，无不利。"
                ]
            },
            {
                "id": 34,
                "name": "大壮",
                "alias": "雷天大壮",
                "gua": [1, 1, 1, 1, 0, 0],
                "description": "利贞。",
                "overall": "大壮卦象征强盛壮大，表示阳气旺盛，力量强大。",
                "details": "大壮卦上震下乾，雷行于天上，声势浩大。阳爻已经占四个位置，非常强盛。此时最重要的是要坚守正道（利贞），不能恃强凌弱，否则会由盛转衰。",
                "lines": [
                    "初九：壮于趾，征凶，有孚。",
                    "九二：贞吉。",
                    "九三：小人用壮，君子用罔，贞厉。羝羊触藩，羸其角。",
                    "九四：贞吉悔亡，藩决不羸，壮于大舆之輹。",
                    "六五：丧羊于易，无悔。",
                    "上六：羝羊触藩，不能退，不能遂，无攸利，艰则吉。"
                ]
            },
            {
                "id": 35,
                "name": "晋",
                "alias": "火地晋",
                "gua": [0, 0, 0, 1, 0, 1],
                "description": "康侯用锡马蕃庶，昼日三接。",
                "overall": "晋卦象征前进和晋升，表示事业顺利发展。",
                "details": "晋卦上离下坤，日出地面，光明普照，万物生长，象征着晋升和发展。如同贤明的诸侯得到君王的赏识，获得众多车马的赏赐，并且在一天之内得到多次接见。此时是事业发展的良机。",
                "lines": [
                    "初六：晋如摧如，贞吉。罔孚，裕无咎。",
                    "六二：晋如愁如，贞吉。受兹介福，于其王母。",
                    "六三：众允，悔亡。",
                    "九四：晋如鼫鼠，贞厉。",
                    "六五：悔亡，失得勿恤，往吉，无不利。",
                    "上九：晋其角，维用伐邑，厉吉无咎，贞吝。"
                ]
            },
            {
                "id": 36,
                "name": "明夷",
                "alias": "地火明夷",
                "gua": [1, 0, 1, 0, 0, 0],
                "description": "利艰贞。",
                "overall": "明夷卦象征光明受到伤害，表示君子在黑暗时期要韬光养晦。",
                "details": "明夷卦上坤下离，光明入于地下，象征着光明被黑暗所伤。此时是有才华的君子受到迫害的时期，利于在艰难困苦中坚守正道。要收敛自己的光芒，外表柔顺而内心智慧，以度过难关。",
                "lines": [
                    "初九：明夷于飞，垂其翼。君子于行，三日不食。有攸往，主人有言。",
                    "六二：明夷，夷于左股，用拯马壮，吉。",
                    "九三：明夷于南狩，得其大首，不可疾贞。",
                    "六四：入于左腹，获明夷之心，于出门庭。",
                    "六五：箕子之明夷，利贞。",
                    "上六：不明晦，初登于天，后入于地。"
                ]
            },
            {
                "id": 37,
                "name": "家人",
                "alias": "风火家人",
                "gua": [1, 0, 1, 0, 1, 1],
                "description": "利女贞。",
                "overall": "家人卦象征家庭，表示家庭内部的伦理和责任。",
                "details": "家人卦上巽下离，风自火出，象征着由内而外的教化。此卦强调家庭中每个成员各守其道，尤其是女主人在家中的重要作用，要坚守正道才能使家庭和睦。治家之道推而广之，就是治国之道。",
                "lines": [
                    "初九：闲有家，悔亡。",
                    "六二：无攸遂，在中馈，贞吉。",
                    "九三：家人嗃嗃，悔厉吉。妇子嘻嘻，终吝。",
                    "六四：富家，大吉。",
                    "九五：王假有家，勿恤，吉。",
                    "上九：有孚威如，终吉。"
                ]
            },
            {
                "id": 38,
                "name": "睽",
                "alias": "火泽睽",
                "gua": [1, 1, 0, 1, 0, 1],
                "description": "小事吉。",
                "overall": "睽卦象征乖离和对立，表示事物处于矛盾对立的状态。",
                "details": "睽卦上离下兑，火向上炎，泽向下润，二女同居而志向不同，象征着乖违和对立。在这种大的对立环境中，难以成就大事，但小的方面可以求同存异，获得吉祥。",
                "lines": [
                    "初九：悔亡。丧马，勿逐自复。见恶人，无咎。",
                    "九二：遇主于巷，无咎。",
                    "六三：见舆曳，其牛掣，其人天且劓，无初有终。",
                    "九四：睽孤，遇元夫，交孚，厉无咎。",
                    "六五：悔亡，厥宗噬肤，往何咎。",
                    "上九：睽孤，见豕负涂，载鬼一车，先张之弧，后说之弧，匪寇婚媾，往遇雨则吉。"
                ]
            },
            {
                "id": 39,
                "name": "蹇",
                "alias": "水山蹇",
                "gua": [0, 0, 1, 0, 1, 0],
                "description": "利西南，不利东北。利见大人，贞吉。",
                "overall": "蹇卦象征艰难和险阻，表示前有险阻，寸步难行。",
                "details": "蹇卦上坎下艮，前有险水，后有高山，象征进退两难。此时应寻求平坦之地（西南）发展，避开险阻（东北）。利于求见有德的“大人”指点迷津，坚守正道可获吉祥。",
                "lines": [
                    "初六：往蹇来誉。",
                    "六二：王臣蹇蹇，匪躬之故。",
                    "九三：往蹇来反。",
                    "六四：往蹇来连。",
                    "九五：大蹇朋来。",
                    "上六：往蹇来硕，吉，利见大人。"
                ]
            },
            {
                "id": 40,
                "name": "解",
                "alias": "雷水解",
                "gua": [0, 1, 0, 1, 0, 0],
                "description": "利西南。无所往，其来复吉。有攸往，夙吉。",
                "overall": "解卦象征缓解和解除，表示困难时期已经过去。",
                "details": "解卦上震下坎，雷雨交作，万物苏醒，象征着险难得以缓解。此时利于去往平顺的地方（西南）。如果无事可做，回到原来的地方也能吉祥。如果有事要做，尽早行动就能获得吉祥。",
                "lines": [
                    "初六：无咎。",
                    "九二：田获三狐，得黄矢，贞吉。",
                    "六三：负且乘，致寇至，贞吝。",
                    "九四：解而拇，朋至斯孚。",
                    "六五：君子维有解，吉。有孚于小人。",
                    "上六：公用射隼于高墉之上，获之，无不利。"
                ]
            },
            {
                "id": 41,
                "name": "损",
                "alias": "山泽损",
                "gua": [1, 1, 0, 0, 0, 1],
                "description": "有孚，元吉，无咎，可贞，利有攸往。曷之用，二簋可用享。",
                "overall": "损卦象征减损和损失，表示损下益上。",
                "details": "损卦上艮下兑，山下有泽，泽气蒸发，减损了泽水，增益了山上的草木。象征着减损下方以增益上方。只要心怀诚信，就能大吉大利，没有灾祸，可以坚守正道，利于前行。减损要适度，即使是简单的祭品也能表达诚意。",
                "lines": [
                    "初九：已事遄往，无咎，酌损之。",
                    "九二：利贞，征凶，弗损益之。",
                    "六三：三人行，则损一人；一人行，则得其友。",
                    "六四：损其疾，使遄有喜，无咎。",
                    "六五：或益之十朋之龟，弗克违，元吉。",
                    "上九：弗损益之，无咎，贞吉，利有攸往，得臣无家。"
                ]
            },
            {
                "id": 42,
                "name": "益",
                "alias": "风雷益",
                "gua": [1, 0, 0, 0, 1, 1],
                "description": "利有攸往，利涉大川。",
                "overall": "益卦象征增益和助益，表示损上益下。",
                "details": "益卦上巽下震，风雷激荡，象征着增益。减损上层以增益下层，是国家大治的体现。此时利于前行，利于冒险犯难，因为得到了民众的支持。",
                "lines": [
                    "初九：利用为大作，元吉，无咎。",
                    "六二：或益之十朋之龟，弗克违，永贞吉。王用享于帝，吉。",
                    "六三：益之用凶事，无咎。有孚中行，告公用圭。",
                    "六四：中行，告公从。利用为依迁国。",
                    "九五：有孚惠心，勿问元吉。有孚惠我德。",
                    "上九：莫益之，或击之，立心勿恒，凶。"
                ]
            },
            {
                "id": 43,
                "name": "夬",
                "alias": "泽天夬",
                "gua": [1, 1, 1, 1, 1, 0],
                "description": "扬于王庭，孚号，有厉。告自邑，不利即戎，利有攸往。",
                "overall": "夬卦象征决断和清除，表示要果断地清除小人。",
                "details": "夬卦上兑下乾，泽水决天，象征着决断。五个阳爻要决去最上面的一个阴爻，象征君子要清除小人。要在朝堂上公开其罪状，诚心呼号，但仍有危险。应先在自己的封地内整顿，不宜马上用兵，但总的来说利于前行。",
                "lines": [
                    "s初九：壮于前趾，往不胜为咎。",
                    "九二：惕号，莫夜有戎，勿恤。",
                    "九三：壮于頄，有凶。君子夬夬独行，遇雨若濡，有愠，无咎。",
                    "九四：其行次且，牵羊悔亡，闻言不信。",
                    "九五：苋陆夬夬，中行无咎。",
                    "上六：无号，终有凶。"
                ]
            },
            {
                "id": 44,
                "name": "姤",
                "alias": "天风姤",
                "gua": [0, 1, 1, 1, 1, 1],
                "description": "女壮，勿用取女。",
                "overall": "姤卦象征相遇，表示阴气初生，要警惕小人。",
                "details": "姤卦上乾下巽，天风相遇。一个阴爻初生于下，与五个阳爻相遇，象征着小人势力的出现。此阴爻强势，所以说“女壮”，不可娶这样的女子为妻。君子要防微杜渐，警惕小人的侵蚀。",
                "lines": [
                    "初六：系于金柅，贞吉。有攸往，见凶，羸豕孚蹢躅。",
                    "九二：包有鱼，无咎，不利宾。",
                    "九三：其行次且，厉，无大咎。",
                    "九四：包无鱼，起凶。",
                    "九五：以杞包瓜，含章，有陨自天。",
                    "上九：姤其角，吝，无咎。"
                ]
            },
            {
                "id": 45,
                "name": "萃",
                "alias": "泽地萃",
                "gua": [0, 0, 0, 1, 1, 0],
                "description": "亨。王假有庙，利见大人，亨，利贞。用大牲吉，利有攸往。",
                "overall": "萃卦象征聚集和会合，表示人才会聚，事业兴旺。",
                "details": "萃卦上兑下坤，泽在地上，水聚于地，象征着聚合。此时亨通。君王到宗庙祭祀，聚集人心。利于求见大人，利于坚守正道。用丰盛的祭品是吉祥的，利于前行。",
                "lines": [
                    "初六：有孚不终，乃乱乃萃，若号，一握为笑，勿恤，往无咎。",
                    "六二：引吉，无咎，孚乃利用禴。",
                    "六三：萃如嗟如，无攸利，往无咎，小吝。",
                    "九四：大吉，无咎。",
                    "九五：萃有位，无咎。匪孚，元永贞，悔亡。",
                    "上六：赍咨涕洟，无咎。"
                ]
            },
            {
                "id": 46,
                "name": "升",
                "alias": "地风升",
                "gua": [0, 1, 1, 0, 0, 0],
                "description": "元亨，用见大人，勿恤，南征吉。",
                "overall": "升卦象征上升和生长，表示不断成长，稳步上升。",
                "details": "升卦上坤下巽，地中生木，木由小到大，不断向上生长，象征着上升。此时大亨通，利于求见大人，不必忧虑，向南方进取是吉祥的。上升要循序渐进，不可急于求成。",
                "lines": [
                    "初六：允升，大吉。",
                    "九二：孚乃利用禴，无咎。",
                    "九三：升虚邑。",
                    "六四：王用亨于岐山，吉，无咎。",
                    "六五：贞吉，升阶。",
                    "上六：冥升，利于不息之贞。"
                ]
            },
            {
                "id": 47,
                "name": "困",
                "alias": "泽水困",
                "gua": [0, 1, 0, 1, 1, 0],
                "description": "亨，贞，大人吉，无咎。有言不信。",
                "overall": "困卦象征困穷和困境，表示身处困境，但能保持气节。",
                "details": "困卦上兑下坎，泽中无水，象征困穷。但对于君子来说，困境是磨练意志的时候，能够亨通。坚守正道，大人是吉祥的，没有灾祸。此时说的话别人可能不相信，需要用行动来证明自己。",
                "lines": [
                    "初六：臀困于株木，入于幽谷，三岁不觌。",
                    "九二：困于酒食，朱绂方来，利用亨祀。征凶，无咎。",
                    "六三：困于石，据于蒺藜，入于其宫，不见其妻，凶。",
                    "九四：来徐徐，困于金车，吝，有终。",
                    "九五：劓刖，困于赤绂，乃徐有说，利用祭祀。",
                    "上六：困于葛藟，于臲卼，曰动悔。有悔，征吉。"
                ]
            },
            {
                "id": 48,
                "name": "井",
                "alias": "水风井",
                "gua": [0, 1, 1, 0, 1, 0],
                "description": "改邑不改井，无丧无得，往来井井。汔至，亦未繘井，羸其瓶，凶。",
                "overall": "井卦象征水井，表示养育不穷，但需善加维护。",
                "details": "井卦上坎下巽，木上有水，如打水的木桶。井象征着社会的基本结构和养育万民的资源，可以改变城邑，但井是不能改变的。它不增不减，人们来来往往取水。但如果快打到水了却绳子不够长，或者弄破了瓶子，都是凶险的。比喻要善于利用和维护公共资源。",
                "lines": [
                    "初六：井泥不食，旧井无禽。",
                    "九二：井谷射鲋，瓮敝漏。",
                    "九三：井渫不食，为我心恻，可用汲，王明，并受其福。",
                    "六四：井甃，无咎。",
                    "九五：井冽，寒泉食。",
                    "上六：井收勿幕，有孚元吉。"
                ]
            },
            {
                "id": 49,
                "name": "革",
                "alias": "泽火革",
                "gua": [1, 0, 1, 1, 1, 0],
                "description": "巳日乃孚，元亨利贞，悔亡。",
                "overall": "革卦象征变革和革命，表示必须进行变革才能发展。",
                "details": "革卦上兑下离，泽中有火，水火相克，象征着变革。变革是顺应天道民心的，要到时机成熟（巳日）才能获得信任，从而大亨通，利于坚守正道，悔恨消失。变革需要审慎，不可轻举妄动。",
                "lines": [
                    "初九：巩用黄牛之革。",
                    "六二：巳日乃革之，征吉，无咎。",
                    "九三：征凶，贞厉。革言三就，有孚。",
                    "九四：悔亡，有孚改命，吉。",
                    "九五：大人虎变，未占有孚。",
                    "上六：君子豹变，小人革面，征凶，居贞吉。"
                ]
            },
            {
                "id": 50,
                "name": "鼎",
                "alias": "火风鼎",
                "gua": [0, 1, 1, 1, 0, 1],
                "description": "元吉，亨。",
                "overall": "鼎卦象征鼎器，表示革故鼎新，养贤育才。",
                "details": "鼎卦上离下巽，木上燃火，烹饪食物，象征着养育。鼎是国家的重器，象征着稳固和权威。此卦是继革卦之后，表示变革之后要建立新的秩序，安稳大局，养贤育才，所以大吉大利，亨通。",
                "lines": [
                    "初六：鼎颠趾，利出否，得妾以其子，无咎。",
                    "九二：鼎有实，我仇有疾，不我能即，吉。",
                    "九三：鼎耳革，其行塞，雉膏不食，方雨亏悔，终吉。",
                    "九四：鼎折足，覆公餗，其形渥，凶。",
                    "六五：鼎黄耳金铉，利贞。",
                    "上九：鼎玉铉，大吉，无不利。"
                ]
            },
            {
                "id": 51,
                "name": "震",
                "alias": "震为雷",
                "gua": [1, 0, 0, 1, 0, 0],
                "description": "亨。震来虩虩，笑言哑哑。震惊百里，不丧匕鬯。",
                "overall": "震卦象征雷动和震惊，表示在惊恐中保持镇定。",
                "details": "震卦上下皆为震，是双重的雷动，象征巨大的震动和变革。此时亨通。雷声传来时虽然恐惧，但能处变不惊，谈笑自若。即使雷声震惊百里，也不会丢失祭祀的勺子和美酒。比喻君子在危难面前能保持镇定，恪守职责。",
                "lines": [
                    "初九：震来虩虩，后笑言哑哑，吉。",
                    "六二：震来厉，亿丧贝，跻于九陵，勿逐，七日得。",
                    "六三：震苏苏，震行无眚。",
                    "九四：震遂泥。",
                    "六五：震往来厉，亿无丧，有事。",
                    "上六：震索索，视矍矍，征凶。震不于其躬，于其邻，无咎。婚媾有言。"
                ]
            },
            {
                "id": 52,
                "name": "艮",
                "alias": "艮为山",
                "gua": [0, 0, 1, 0, 0, 1],
                "description": "艮其背，不获其身，行其庭，不见其人，无咎。",
                "overall": "艮卦象征停止和静止，表示应适时停止。",
                "details": "艮卦上下皆为艮，是双重的山，象征着静止。要像背对一样，做到视而不见，心无旁骛，达到物我两忘的境界。虽然走在庭院里，却好像没有看到人一样。这样就能没有灾祸。强调内心要专一宁静，不为外物所动。",
                "lines": [
                    "初六：艮其趾，无咎，利永贞。",
                    "六二：艮其腓，不拯其随，其心不快。",
                    "九三：艮其限，列其夤，厉薰心。",
                    "六四：艮其身，无咎。",
                    "六五：艮其辅，言有序，悔亡。",
                    "上九：敦艮，吉。"
                ]
            },
            {
                "id": 53,
                "name": "渐",
                "alias": "风山渐",
                "gua": [0, 0, 1, 0, 1, 1],
                "description": "女归吉，利贞。",
                "overall": "渐卦象征渐进，表示事物发展要循序渐进。",
                "details": "渐卦上巽下艮，山上有木，木依山而长，是逐渐成长的过程。象征着事物的发展要按部就班，循序渐进。如同女子出嫁要遵循一定的礼仪程序一样，这样才能吉祥，利于坚守正道。",
                "lines": [
                    "初六：鸿渐于干，小子厉，有言，无咎。",
                    "六二：鸿渐于磐，饮食衎衎，吉。",
                    "九三：鸿渐于陆，夫征不复，妇孕不育，凶。利御寇。",
                    "六四：鸿渐于木，或得其桷，无咎。",
                    "九五：鸿渐于陵，妇三岁不孕，终莫之胜，吉。",
                    "上九：鸿渐于逵，其羽可用为仪，吉。"
                ]
            },
            {
                "id": 54,
                "name": "归妹",
                "alias": "雷泽归妹",
                "gua": [1, 1, 0, 1, 0, 0],
                "description": "征凶，无攸利。",
                "overall": "归妹卦象征少女出嫁，表示关系不正，前景堪忧。",
                "details": "归妹卦上震下兑，长男配少女，关系不正常。如同少女急于出嫁，不合礼法。因此，贸然前行是凶险的，没有任何好处。此卦警示人们，行为要符合正道和常规，否则会带来不好的结果。",
                "lines": [
                    "初九：归妹以娣，跛能履，征吉。",
                    "九二：眇能视，利幽人之贞。",
                    "六三：归妹以须，反归以娣。",
                    "九四：归妹愆期，迟归有时。",
                    "六五：帝乙归妹，其君之袂，不如其娣之袂良。月几望，吉。",
                    "上六：女承筐无实，士刲羊无血，无攸利。"
                ]
            },
            {
                "id": 55,
                "name": "丰",
                "alias": "雷火丰",
                "gua": [1, 0, 1, 1, 0, 0],
                "description": "亨，王假之，勿忧，宜日中。",
                "overall": "丰卦象征丰大和盛大，表示事业达到顶峰。",
                "details": "丰卦上震下离，雷电交加，光明而动，象征着盛大丰满。此时亨通，君王能够达到盛世。不必忧虑，但要像中午的太阳一样，虽然光芒万丈，但马上就要开始偏斜，要警惕盛极而衰。",
                "lines": [
                    "初九：遇其配主，虽旬无咎，往有尚。",
                    "六二：丰其蔀，日中见斗，往得疑疾，有孚发若，吉。",
                    "九三：丰其沛，日中见沫，折其右肱，无咎。",
                    "九四：丰其蔀，日中见斗，遇其夷主，吉。",
                    "六五：来章，有庆誉，吉。",
                    "上六：丰其屋，蔀其家，窥其户，阒其无人，三岁不觌，凶。"
                ]
            },
            {
                "id": 56,
                "name": "旅",
                "alias": "火山旅",
                "gua": [0, 0, 1, 1, 0, 1],
                "description": "小亨，旅贞吉。",
                "overall": "旅卦象征旅行和漂泊，表示客居在外，要谨慎行事。",
                "details": "旅卦上离下艮，山上有火，火不久居，象征行旅。客居在外，势单力薄，只能小有亨通。在旅途中要坚守正道，才能获得吉祥。要谦逊待人，遵守当地的规则。",
                "lines": [
                    "初六：旅琐琐，斯其所取灾。",
                    "六二：旅即次，怀其资，得童仆贞。",
                    "九三：旅焚其次，丧其童仆，贞厉。",
                    "九四：旅于处，得其资斧，我心不快。",
                    "六五：射雉，一矢亡，终以誉命。",
                    "上九：鸟焚其巢，旅人先笑后号啕。丧牛于易，凶。"
                ]
            },
            {
                "id": 57,
                "name": "巽",
                "alias": "巽为风",
                "gua": [0, 1, 1, 0, 1, 1],
                "description": "小亨，利有攸往，利见大人。",
                "overall": "巽卦象征巽顺和进入，表示要谦逊顺从。",
                "details": "巽卦上下皆为巽，是双重的风，无孔不入，象征着顺从。谦逊顺从可以小有亨通，利于前行，利于求见大人。但顺从不是无原则的，要有自己的主见，在顺从中贯彻自己的意图。",
                "lines": [
                    "初六：进退，利武人之贞。",
                    "九二：巽在床下，用史巫纷若，吉，无咎。",
                    "九三：频巽，吝。",
                    "六四：悔亡，田获三品。",
                    "九五：贞吉悔亡，无不利。无初有终，先庚三日，后庚三日，吉。",
                    "上九：巽在床下，丧其资斧，贞凶。"
                ]
            },
            {
                "id": 58,
                "name": "兑",
                "alias": "兑为泽",
                "gua": [1, 1, 0, 1, 1, 0],
                "description": "亨，利贞。",
                "overall": "兑卦象征喜悦和言说，表示和悦待人。",
                "details": "兑卦上下皆为兑，是双重的泽，象征着喜悦。以喜悦的态度待人，能够亨通，利于坚守正道。与朋友讲习交流，是人生乐事。但喜悦应发自内心，以正道为基础，否则会流于邪僻。",
                "lines": [
                    "初九：和兑，吉。",
                    "九二：孚兑，吉，悔亡。",
                    "六三：来兑，凶。",
                    "九四：商兑未宁，介疾有喜。",
                    "九五：孚于剥，有厉。",
                    "上六：引兑。"
                ]
            },
            {
                "id": 59,
                "name": "涣",
                "alias": "风水涣",
                "gua": [0, 1, 1, 0, 0, 1],
                "description": "亨。王假有庙，利涉大川，利贞。",
                "overall": "涣卦象征涣散和离散，表示要拯济涣散的人心。",
                "details": "涣卦上巽下坎，风行水上，吹散水气，象征涣散。此时人心离散，需要君王到宗庙祭祀，以凝聚人心。利于冒险犯难，以挽救危局。利于坚守正道。",
                "lines": [
                    "初六：用拯马壮，吉。",
                    "九二：涣奔其机，悔亡。",
                    "六三：涣其躬，无悔。",
                    "六四：涣其群，元吉。涣有丘，匪夷所思。",
                    "九五：涣汗其大号，涣王居，无咎。",
                    "上九：涣其血，去逖出，无咎。"
                ]
            },
            {
                "id": 60,
                "name": "节",
                "alias": "水泽节",
                "gua": [1, 1, 0, 0, 1, 0],
                "description": "亨。苦节，不可贞。",
                "overall": "节卦象征节制和节约，表示凡事要有节度。",
                "details": "节卦上坎下兑，泽上有水，水满则溢，需要节制。节制能够亨通。但如果节制过度，变成了“苦节”，就不能长久坚守了。节制要恰到好处，才能发挥其积极作用。",
                "lines": [
                    "初九：不出户庭，无咎。",
                    "九二：不出门庭，凶。",
                    "六三：不节若，则嗟若，无咎。",
                    "六四：安节，亨。",
                    "九五：甘节，吉，往有尚。",
                    "上六：苦节，贞凶，悔亡。"
                ]
            },
            {
                "id": 61,
                "name": "中孚",
                "alias": "风泽中孚",
                "gua": [1, 1, 0, 0, 1, 1],
                "description": "豚鱼吉，利涉大川，利贞。",
                "overall": "中孚卦象征诚信，表示内心诚信，能感化万物。",
                "details": "中孚卦上下为阳爻，中间二阴二阳，形如心中诚信。诚信的力量巨大，连豚鱼这样的小动物都能被感化，获得吉祥。利于冒险犯难，利于坚守正道。诚信是立身之本，成功之基。",
                "lines": [
                    "初九：虞吉，有他不燕。",
                    "九二：鸣鹤在阴，其子和之。我有好爵，吾与尔靡之。",
                    "六三：得敌，或鼓或罢，或泣或歌。",
                    "六四：月几望，马匹亡，无咎。",
                    "九五：有孚挛如，无咎。",
                    "上九：翰音登于天，贞凶。"
                ]
            },
            {
                "id": 62,
                "name": "小过",
                "alias": "雷山小过",
                "gua": [0, 0, 1, 1, 0, 0],
                "description": "亨，利贞。可小事，不可大事。飞鸟遗之音，不宜上，宜下，大吉。",
                "overall": "小过卦象征小的过越，表示行动可小有超过，但不可过大。",
                "details": "小过卦四阴爻在外，二阳爻在内，阴气过盛。此时亨通，利于坚守正道。可以做一些小事，但不能做大事。如同飞鸟空中鸣叫，警示人们此时不宜向上发展，而应向下谦卑自处，才能大吉大利。",
                "lines": [
                    "初六：飞鸟以凶。",
                    "六二：过其祖，遇其妣；不及其君，遇其臣，无咎。",
                    "九三：弗过防之，从或戕之，凶。",
                    "九四：无咎，弗过遇之。往厉必戒，勿用永贞。",
                    "六五：密云不雨，自我西郊，公弋取彼在穴。",
                    "上六：弗过遇之，飞鸟离之，凶，是谓灾眚。"
                ]
            },
            {
                "id": 63,
                "name": "既济",
                "alias": "水火既济",
                "gua": [1, 0, 1, 0, 1, 0],
                "description": "亨，小利贞，初吉终乱。",
                "overall": "既济卦象征事情已经成功，表示成功之后要保持警惕。",
                "details": "既济卦上坎下离，水在火上，水火相济，六爻皆当位，象征着事情已经完成，非常完美。此时亨通，小的方面利于坚守正道。但开始是吉祥的，最终可能会陷入混乱。成功之后容易懈怠，必须居安思危，防患于未然。",
                "lines": [
                    "初九：曳其轮，濡其尾，无咎。",
                    "六二：妇丧其茀，勿逐，七日得。",
                    "九三：高宗伐鬼方，三年克之，小人勿用。",
                    "六四：繻有衣袽，终日戒。",
                    "九五：东邻杀牛，不如西邻之禴祭，实受其福。",
                    "上六：濡其首，厉。"
                ]
            },
            {
                "id": 64,
                "name": "未济",
                "alias": "火水未济",
                "gua": [0, 1, 0, 1, 0, 1],
                "description": "亨，小狐汔济，濡其尾，无攸利。",
                "overall": "未济卦象征事情尚未成功，表示未来充满希望。",
                "details": "未济卦上离下坎，火在水上，水火不交，六爻皆不当位，象征事情尚未完成。但正因未完成，未来才充满无限可能，所以亨通。如同小狐狸快要渡过河，却打湿了尾巴，没有好处。比喻做事要有始有终，不可功亏一篑。要审慎行事，才能走向成功。",
                "lines": [
                    "初六：濡其尾，吝。",
                    "九二：曳其轮，贞吉。",
                    "六三：未济，征凶，利涉大川。",
                    "九四：贞吉悔亡，震用伐鬼方，三年有赏于大国。",
                    "六五：贞吉，无悔，君子之光，有孚吉。",
                    "上九：有孚于饮酒，无咎，濡其首，有孚失是。"
                ]
            }
        ]

        // State variables
        let currentYao = 0;
        let yaoValues = [];
        let isAnimating = false;
        let originalHexagram = null;
        let changingHexagram = null;
        let apiKey = localStorage.getItem('deepseek_api_key') || '';

        // DOM Elements
        const tossButton = document.getElementById('toss-button');
        const newDivinationButton = document.getElementById('new-divination');
        const divinationSection = document.getElementById('divination-section');
        const resultSection = document.getElementById('result-section');
        const yaoContainer = document.getElementById('yao-container');
        const coins = document.querySelectorAll('.coin');

        // Modal elements
        const historyModal = document.getElementById('history-modal');
        const historyButton = document.getElementById('history-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const clearHistoryButton = document.getElementById('clear-history-button');
        const historyList = document.getElementById('history-list');

        // Functions
        const initYaoContainer = () => {
            yaoContainer.innerHTML = '';
            for (let i = 5; i >= 0; i--) {
                const yaoSlot = document.createElement('div');
                yaoSlot.id = `yao-${i}`;
                yaoSlot.className = 'w-full h-8 bg-gray-200 rounded-md border-2 border-dashed border-gray-300 transition-all duration-500';
                yaoContainer.appendChild(yaoSlot);
            }
        };

        const updateYaoDisplay = (position, value) => {
            const yaoElement = document.getElementById(`yao-${position}`);
            yaoElement.classList.remove('bg-gray-200', 'border-dashed', 'border-gray-300');
            const classes = ['h-8', 'w-full', 'rounded-md', 'relative', 'transition-all', 'duration-500'];

            switch (value) {
                case 0: // yin
                    classes.push('bg-gray-700', 'yin');
                    break;
                case 1: // yang
                    classes.push('bg-blue-600', 'yang');
                    break;
                case 2: // yin changing
                    classes.push('bg-gray-700', 'yin', 'changing');
                    break;
                case 3: // yang changing
                    classes.push('bg-blue-600', 'yang', 'changing');
                    break;
            }
            yaoElement.className = 'yao ' + classes.join(' ');
        };

        const tossCoin = () => {
            if (isAnimating || currentYao >= 6) return;
            isAnimating = true;
            tossButton.disabled = true;

            let coinResults = [];

            coins.forEach((coin, index) => {
                setTimeout(() => {
                    coin.classList.add('is-flipping');
                    const result = Math.round(Math.random());
                    coinResults[index] = result;

                    const rotation = coin.style.transform ? parseInt(coin.style.transform.replace('rotateY(', '').replace('deg)', '')) : 0;
                    const newRotation = rotation + 1800 + (result === 0 ? 180 : 0);
                    coin.style.transform = `rotateY(${newRotation}deg)`;

                }, index * 100);
            });

            setTimeout(() => {
                const headsCount = coinResults.reduce((sum, result) => sum + result, 0);
                const yaoValue = { 3: 1, 2: 3, 1: 2, 0: 0 }[headsCount];
                yaoValues[currentYao] = yaoValue;
                updateYaoDisplay(currentYao, yaoValue);
                currentYao++;

                if (currentYao < 6) {
                    tossButton.textContent = `继续掷爻 (${currentYao + 1}/6)`;
                    tossButton.disabled = false;
                } else {
                    tossButton.textContent = '查看结果';
                    tossButton.disabled = false;
                    setTimeout(showResult, 500);
                }

                isAnimating = false;
            }, 1200);
        };

        const arraysEqual = (a, b) => a.length === b.length && a.every((val, index) => val === b[index]);

        // =======================================================
        // ==               CORRECTED FUNCTION                  ==
        // =======================================================
        // The .reverse() and .slice() methods were removed. 
        // This function now correctly compares the bottom-to-top generated
        // array with the bottom-to-top data array.
        const findHexagram = (yaoArray) => hexagrams.find(h => arraysEqual(h.gua, yaoArray));

        const calculateHexagrams = () => {
            const originalYao = yaoValues.map(v => v % 2);
            originalHexagram = findHexagram(originalYao);

            const hasChangingLines = yaoValues.some(v => v === 2 || v === 3);
            if (hasChangingLines) {
                const changingYao = yaoValues.map(v => v === 2 ? 1 : (v === 3 ? 0 : v));
                changingHexagram = findHexagram(changingYao);
            } else {
                changingHexagram = null;
            }
        };

        const drawHexagram = (elementId, gua) => {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            // The gua array from data is already in correct order (bottom to top), so we iterate normally.
            gua.forEach((yaoValue, index) => {
                const yaoElement = document.createElement('div');
                const classes = ['yao', 'h-4', 'w-full', 'rounded-sm', 'relative'];
                classes.push(yaoValue === 1 ? 'bg-blue-600 yang' : 'bg-gray-700 yin');

                // Add changing line indicator if applicable to original hexagram
                if (elementId === 'hexagram-image' && (yaoValues.slice().reverse()[index] === 2 || yaoValues.slice().reverse()[index] === 3)) {
                    classes.push('changing');
                }

                yaoElement.className = classes.join(' ');
                container.appendChild(yaoElement);
            });
        };

        const showResult = () => {
            // Ensure hexagram data exists before proceeding
            if (!hexagrams || hexagrams.length < 64) {
                resultSection.innerHTML = `<p class="text-center text-red-500">卦象数据不完整，请检查代码中的 hexagrams 数组。</p>`;
                divinationSection.classList.add('hidden');
                resultSection.classList.remove('hidden');
                return;
            }

            calculateHexagrams();
            divinationSection.classList.add('hidden');
            resultSection.classList.remove('hidden');

            if (!originalHexagram) {
                resultSection.innerHTML = `<p class="text-center text-red-500">无法找到对应的卦象，请重试。</p><p class="text-center text-gray-500 text-sm mt-2">(这通常是由于卦象基础数据不完整导致的)</p>`;
                return;
            }

            // Update display
            document.getElementById('hexagram-name').textContent = `${originalHexagram.name} - ${originalHexagram.alias}`;
            document.getElementById('hexagram-code').textContent = `第 ${originalHexagram.id} 卦`;
            drawHexagram('hexagram-image', originalHexagram.gua);

            if (changingHexagram) {
                document.getElementById('hexagram-changing-section').classList.remove('hidden');
                document.getElementById('arrow-container').classList.remove('hidden');
                document.getElementById('hexagram-changing-name').textContent = `${changingHexagram.name} - ${changingHexagram.alias}`;
                document.getElementById('hexagram-changing-code').textContent = `第 ${changingHexagram.id} 卦 (变卦)`;
                drawHexagram('hexagram-changing-image', changingHexagram.gua);
            } else {
                document.getElementById('hexagram-changing-section').classList.add('hidden');
                document.getElementById('arrow-container').classList.add('hidden');
            }

            setupTabsAndContent();
            saveToHistory();
        };

        const setupTabsAndContent = () => {
            const tabs = [
                { id: 'general', title: '卦辞' },
                { id: 'details', title: '详解' },
                { id: 'lines', title: '爻辞' },
                { id: 'ai', title: 'AI解卦' },
            ];

            const tabsContainer = document.getElementById('tabs-container');
            const tabContent = document.getElementById('tab-content');
            tabsContainer.innerHTML = '';
            tabContent.innerHTML = '';

            tabs.forEach((tab, index) => {
                // Create tab button
                const button = document.createElement('a');
                button.href = '#';
                button.dataset.tab = tab.id;
                button.className = `tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${index === 0 ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`;
                button.textContent = tab.title;
                tabsContainer.appendChild(button);

                // Create tab pane
                const pane = document.createElement('div');
                pane.id = `pane-${tab.id}`;
                pane.className = `tab-pane ${index !== 0 ? 'hidden' : ''}`;
                tabContent.appendChild(pane);
            });

            populateTabContent();

            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', e => {
                    e.preventDefault();
                    const tabId = e.target.dataset.tab;

                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('border-blue-500', 'text-blue-600');
                        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    });
                    e.target.classList.add('border-blue-500', 'text-blue-600');
                    e.target.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.add('hidden');
                    });
                    document.getElementById(`pane-${tabId}`).classList.remove('hidden');
                });
            });
        };

        const populateTabContent = () => {
            // General
            document.getElementById('pane-general').innerHTML = `
                <h3 class="text-xl font-bold font-serif mb-2">${originalHexagram.description}</h3>
                <p class="text-gray-600">${originalHexagram.overall}</p>
            `;
            // Details
            document.getElementById('pane-details').innerHTML = `<p class="text-gray-600 leading-relaxed">${originalHexagram.details}</p>`;
            // Lines
            let linesHtml = '';
            const changingLines = [];
            yaoValues.slice().reverse().forEach((v, i) => { if (v === 2 || v === 3) changingLines.push(i) });

            if (changingLines.length > 0) {
                linesHtml += '<p class="font-semibold mb-2">变爻爻辞 (以此为主要参考):</p><div class="space-y-2">';
                changingLines.forEach(lineIndex => {
                    linesHtml += `<p><span class="font-bold text-blue-600 mr-2">第${lineIndex + 1}爻:</span>${originalHexagram.lines[lineIndex]}</p>`;
                });
                linesHtml += '</div>';
                if (changingHexagram) {
                    linesHtml += `<p class="font-semibold mt-4 mb-2">变卦《${changingHexagram.name}》卦辞 (参考未来趋势):</p><p>${changingHexagram.description}</p>`;
                }
            } else {
                linesHtml += '<p class="font-semibold mb-2">无变爻，以本卦卦辞为断。</p>';
                // Optionally show the 'ruler' line
                const rulerLine = originalHexagram.gua.filter(y => y === 1).length > 3 ? 4 : 1; // 5th or 2nd line
                linesHtml += `<p class="mt-4"><span class="font-bold text-gray-500 mr-2">主爻参考 (第${rulerLine + 1}爻):</span>${originalHexagram.lines[rulerLine]}</p>`;
            }
            document.getElementById('pane-lines').innerHTML = linesHtml;

            // AI
            document.getElementById('pane-ai').innerHTML = `
                <div class="p-4 border border-blue-200 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-800 mb-3">请输入您的 DeepSeek API Key 以启用AI解卦。密钥将仅保存在您的浏览器本地，不会上传至任何服务器。</p>
                    <div class="flex items-center gap-2">
                         <input type="password" id="api-key-input" placeholder="sk-..." class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                         <button id="save-api-key" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">保存</button>
                    </div>
                </div>
                <button id="ai-interpret-button" class="mt-4 w-full px-6 py-3 bg-gray-800 text-white font-bold rounded-lg shadow-md hover:bg-black transition disabled:bg-gray-400 disabled:cursor-wait">
                    AI 解卦
                </button>
                <div id="ai-loading" class="hidden text-center mt-4">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                    <p class="text-gray-600">正在生成中，请稍候...</p>
                </div>
                <div id="ai-result" class="mt-4 p-4 border border-gray-200 bg-gray-50 rounded-lg leading-relaxed whitespace-pre-wrap"></div>
            `;

            const apiKeyInput = document.getElementById('api-key-input');
            apiKeyInput.value = apiKey;
            document.getElementById('save-api-key').addEventListener('click', () => {
                apiKey = apiKeyInput.value.trim();
                if (apiKey) {
                    localStorage.setItem('deepseek_api_key', apiKey);
                    alert('API Key已保存!');
                }
            });
            document.getElementById('ai-interpret-button').addEventListener('click', getAIInterpretation);

        };

        const getAIInterpretation = async () => {
            if (!apiKey) {
                alert('请先输入并保存您的DeepSeek API Key。');
                return;
            }

            const aiButton = document.getElementById('ai-interpret-button');
            const aiLoading = document.getElementById('ai-loading');
            const aiResult = document.getElementById('ai-result');

            aiButton.disabled = true;
            aiLoading.classList.remove('hidden');
            aiResult.innerHTML = '';

            const userQuestion = document.getElementById('question').value;
            const changingLinesIdx = [];
            yaoValues.slice().reverse().forEach((v, i) => { if (v === 2 || v === 3) changingLinesIdx.push(i) });
            const changingLinesText = changingLinesIdx.map(i => originalHexagram.lines[i]).join('; ');

            const prompt = `
            请作为一位精通周易的大师，为我解卦。
            我的问题是：“${userQuestion || '未提供具体问题'}”
            
            我得到的本卦是：**${originalHexagram.name}卦 (${originalHexagram.alias})**
            - 卦辞：${originalHexagram.description}
            - 总体象义：${originalHexagram.overall}
            
            ${changingHexagram ? `
            变卦是：**${changingHexagram.name}卦 (${changingHexagram.alias})**
            - 卦辞：${changingHexagram.description}
            - 总体象义：${changingHexagram.overall}
            
            变爻是：
            ${changingLinesText}
            ` : '此卦无变爻。'}
            
            请综合以上信息，用清晰、现代且富有哲理的语言，为我提供详尽的分析，包括：
            1.  **针对问题**：直接回答我的问题，目前情况如何？
            2.  **趋势分析**：事情会如何发展？变卦揭示了怎样的未来走向？
            3.  **行动建议**：我应该注意什么？采取什么行动最为有利？
            
            请分点论述，条理清晰。
            `;

            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{ role: 'user', content: prompt }],
                        stream: false
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API请求失败: ${response.status} - ${errorData.error.message}`);
                }

                const data = await response.json();
                aiResult.textContent = data.choices[0].message.content;

            } catch (error) {
                console.error('AI解卦失败:', error);
                aiResult.innerHTML = `<p class="text-red-600">AI解卦生成失败，请检查您的API Key或网络连接。<br>错误: ${error.message}</p>`;
            } finally {
                aiButton.disabled = false;
                aiLoading.classList.add('hidden');
            }
        };


        const resetDivination = () => {
            currentYao = 0;
            yaoValues = [];
            originalHexagram = null;
            changingHexagram = null;
            isAnimating = false;

            initYaoContainer();
            divinationSection.classList.remove('hidden');
            resultSection.classList.add('hidden');

            tossButton.disabled = false;
            tossButton.textContent = '开始掷爻 (1/6)';

            coins.forEach(coin => {
                coin.classList.remove('is-flipping');
                coin.style.transform = `rotateY(0deg)`;
            });
        };

        // --- History Functions ---
        const getHistory = () => JSON.parse(localStorage.getItem('divinationHistory') || '[]');
        const saveToHistory = () => {
            const history = getHistory();
            const entry = {
                id: Date.now(),
                date: new Date().toLocaleString('zh-CN'),
                question: document.getElementById('question').value || '未记录问题',
                originalHexagram: { id: originalHexagram.id, name: originalHexagram.name, alias: originalHexagram.alias, description: originalHexagram.description },
                changingHexagram: changingHexagram ? { id: changingHexagram.id, name: changingHexagram.name, alias: changingHexagram.alias, description: changingHexagram.description } : null
            };
            history.unshift(entry);
            localStorage.setItem('divinationHistory', JSON.stringify(history.slice(0, 50))); // limit to 50 entries
            loadHistory();
        };

        const loadHistory = () => {
            const history = getHistory();
            if (history.length === 0) {
                historyList.innerHTML = `<p class="text-center text-gray-500">暂无历史记录。</p>`;
                clearHistoryButton.disabled = true;
                return;
            }
            clearHistoryButton.disabled = false;
            historyList.innerHTML = history.map(entry => `
                <div class="p-4 border-b border-gray-100 hover:bg-gray-50 rounded-md">
                    <p class="font-semibold text-gray-800">${entry.question}</p>
                    <p class="text-sm text-gray-500 mb-2">${entry.date}</p>
                    <div class="flex items-center gap-4 text-sm">
                        <span>本卦: <strong class="font-serif">${entry.originalHexagram.name} (${entry.originalHexagram.alias})</strong></span>
                        ${entry.changingHexagram ? `<span>→ 变卦: <strong class="font-serif">${entry.changingHexagram.name}</strong></span>` : ''}
                    </div>
                </div>
            `).join('');
        };

        const toggleModal = (show) => {
            if (show) {
                historyModal.classList.remove('invisible', 'opacity-0');
                historyModal.querySelector('.modal-content').classList.remove('scale-95');
                loadHistory();
            } else {
                historyModal.classList.add('opacity-0');
                historyModal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => historyModal.classList.add('invisible'), 300);
            }
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initYaoContainer();
            tossButton.addEventListener('click', tossCoin);
            newDivinationButton.addEventListener('click', resetDivination);

            // Modal Listeners
            historyButton.addEventListener('click', () => toggleModal(true));
            closeModalButton.addEventListener('click', () => toggleModal(false));
            historyModal.addEventListener('click', (e) => {
                if (e.target === historyModal) toggleModal(false);
            });
            clearHistoryButton.addEventListener('click', () => {
                if (confirm('您确定要清空所有历史记录吗？此操作无法撤销。')) {
                    localStorage.removeItem('divinationHistory');
                    loadHistory();
                }
            });
        });
    </script>
</body>

</html>
