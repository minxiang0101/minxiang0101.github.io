import{v as e}from"./divination-C-nR8R13.js";import{r,i as a}from"./vue-vendor-BDmscHTi.js";const t="yijing-divination-history";function l(){const l=r([]),u=r(null),n=a("errorHandler",null),s=()=>{try{localStorage.setItem(t,JSON.stringify(l.value)),u.value=null}catch(e){u.value="保存历史记录失败",n&&n.handleStorageError({message:"保存历史记录失败",details:e.message})}};return(()=>{try{const e=localStorage.getItem(t);if(e){const r=JSON.parse(e);Array.isArray(r)&&(l.value=r)}u.value=null}catch(e){u.value="加载历史记录失败",n&&n.handleStorageError({message:"加载历史记录失败",details:e.message})}})(),{history:l,error:u,saveRecord:r=>{try{const a=e(r);if(!a.isValid)return u.value=`记录无效: ${a.errors.join(", ")}`,n&&n.handleValidationError(`记录无效: ${a.errors.join(", ")}`),!1;const t=l.value.findIndex(e=>e.id===r.id);return t>=0?l.value[t]={...r}:(l.value.unshift(r),l.value.length>100&&l.value.pop()),s(),n&&n.showSuccess("卜卦记录已保存"),!0}catch(a){return u.value="保存记录失败",n&&n.handleStorageError({message:"保存记录失败",details:a.message}),!1}},getHistory:(e={})=>{try{let r=[...l.value];return e.method&&(r=r.filter(r=>r.method===e.method)),void 0!==e.bookmarked&&(r=r.filter(r=>r.isBookmarked===e.bookmarked)),e.tag&&(r=r.filter(r=>r.tags&&r.tags.includes(e.tag))),u.value=null,r}catch(r){return u.value="获取历史记录失败",[]}},getRecordById:e=>{try{const r=l.value.find(r=>r.id===e);return u.value=null,r||null}catch(r){return u.value="获取记录失败",null}},updateRecord:(e,r)=>{try{const a=l.value.findIndex(r=>r.id===e);return-1===a?(u.value="记录不存在",!1):(l.value[a]={...l.value[a],...r},s(),u.value=null,!0)}catch(a){return u.value="更新记录失败",!1}},deleteRecord:e=>{try{const r=l.value.length;return l.value=l.value.filter(r=>r.id!==e),l.value.length!==r?(s(),u.value=null,n&&n.showSuccess("记录已删除"),!0):(u.value="记录不存在",n&&n.handleValidationError("记录不存在"),!1)}catch(r){return u.value="删除记录失败",n&&n.handleStorageError({message:"删除记录失败",details:r.message}),!1}},clearHistory:()=>{try{return l.value=[],s(),u.value=null,n&&n.showSuccess("历史记录已清空"),!0}catch(e){return u.value="清空历史记录失败",n&&n.handleStorageError({message:"清空历史记录失败",details:e.message}),!1}},exportHistory:()=>{try{const e=JSON.stringify(l.value);return u.value=null,e}catch(e){return u.value="导出历史记录失败",""}},importHistory:(e,r=!1)=>{try{const a=JSON.parse(e);if(!Array.isArray(a))return u.value="导入数据格式无效",!1;if(r){const e=new Set(l.value.map(e=>e.id)),r=a.filter(r=>!e.has(r.id));l.value=[...l.value,...r]}else l.value=a;return s(),u.value=null,!0}catch(a){return u.value="导入历史记录失败",!1}}}}export{l as u};
