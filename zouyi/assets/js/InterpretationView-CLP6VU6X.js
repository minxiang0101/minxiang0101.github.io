import{u as e,_ as t,a}from"./index-BThmZv48.js";import{r as n,c as i,i as o,e as s,L as r,j as l,O as u,Q as c,R as m,_ as d,K as v,B as p,P as g,I as h,N as f,H as w}from"./vue-vendor-BDmscHTi.js";import{H as y}from"./HexagramDisplay-Nzi9gpz8.js";import{I}from"./InterpretationCard-ZiHoPvy5.js";import{u as x}from"./useDivination-BlC7jHpl.js";import{a as k}from"./axios-lib-7ZUa9Kmg.js";import{u as b}from"./useHistory-Dm2P6k7J.js";import{a as $,H as S,b as _}from"./vant-ui-B5UknOXi.js";import"./divination-C-nR8R13.js";function A(e,t=!1){if(!e||"string"!=typeof e)return{title:"解卦内容",subtitle:"暂无内容",sections:[],summary:"暂无解卦内容",timestamp:(new Date).toISOString(),source:"ai",isCustomQuestion:!1};const a=function(e,t=!1){if(!e||"string"!=typeof e)return[];const a=[],n=e.split("\n");let i=null;if(t){const t=e.split("\n\n").filter(e=>e.trim());if(t.length>0&&(a.push({title:"解读回答",content:t[0].split("\n").filter(e=>e.trim()),level:"neutral"}),t.length>1))for(let e=1;e<t.length;e++){const n=t[e].trim();n&&a.push({title:`补充说明 ${e}`,content:n.split("\n").filter(e=>e.trim()),level:"neutral"})}return a}for(const o of n){const e=o.trim();if(!e)continue;e.match(/^#+\s/)||e.match(/^\*\*.*\*\*$/)||e.match(/^\d+\.\s/)||e.match(/^[一二三四五六七八九十]+[、．.]\s/)||e.includes("事业")||e.includes("感情")||e.includes("财运")||e.includes("健康")||e.includes("学业")||e.includes("建议")||e.includes("分析")||e.includes("运势")||e.includes("总结")?(i&&i.content.length>0&&a.push(i),i={title:e.replace(/^#+\s*|\*\*|\d+\.\s*|[一二三四五六七八九十]+[、．.]\s*/g,"").trim(),content:[],level:C(e)}):(i||i||(i={title:"解卦内容",content:[],level:"neutral"}),i.content.push(e))}i&&i.content.length>0&&a.push(i);return a}(e,t);return{title:"AI解卦内容",subtitle:t?"针对性解读":"运势分析",sections:a,summary:function(e){if(!e||"string"!=typeof e)return"暂无总结";const t=[/总结[：:]([\s\S]+?)(?=\n#+|\n\d+\.|\n\*\*|$)/i,/### \*\*总结\*\*([\s\S]+?)(?=\n#+|\n\d+\.|\n\*\*|$)/i,/## 总结([\s\S]+?)(?=\n#+|\n\d+\.|\n\*\*|$)/i,/总结([\s\S]+?)(?=希望这份解析|如有具体问题|$)/i];for(const n of t){const t=e.match(n);if(t&&t[1])return t[1].trim()}const a=e.split("\n").filter(e=>e.trim()).slice(-5);for(let n=a.length-1;n>=0;n--){const e=a[n].trim();if(e.length>20&&(e.includes("提醒")||e.includes("建议")||e.includes("总之")||e.includes("希望")||e.includes("方能")))return e}return"请谨慎行事，以柔克刚，方能化险为夷。"}(e),rawResponse:e,timestamp:(new Date).toISOString(),source:"ai",model:"DeepSeek AI",isCustomQuestion:t}}function C(e){const t=e.toLowerCase();return t.includes("良好")||t.includes("有利")||t.includes("积极")?"good":t.includes("不利")||t.includes("困难")||t.includes("阻碍")?"bad":"neutral"}const P=async(t,a={})=>{const n=e();if(!n.networkStatus.online){const e=new Error("网络连接已断开，请检查网络设置");throw n.handleNetworkError(e,{showDialog:a.showNetworkErrorDialog}),e}let i=null;a.showLoading&&(i=n.showLoading(a.loadingMessage||"加载中...",{forbidClick:!1!==a.forbidClick}));try{const e=await t();return a.showSuccess&&n.showSuccess(a.successMessage||"操作成功",{position:"bottom",duration:2e3}),e}catch(o){throw o}finally{i&&i.close()}};function T(){const t=n("sk-9b420a83fb194533863340b4165a27dd"),a=n("https://api.deepseek.com/v1/chat/completions"),s=n("deepseek-chat"),r=n(!1),l=n(null),u=n(null),c=n(0),m=n(0),d=n(0),v=i(()=>!!t.value),p=i(()=>!!l.value),g=i(()=>0===c.value?0:m.value/c.value*100),h=e=>{const t={"乾":"大吉大利，事业顺遂","坤":"包容守静，厚德载物","震":"行动起始，变革之时","艮":"稳重止行，静待时机","坎":"险中求进，谨慎行事","离":"光明显现，注意内心","巽":"谦逊顺从，柔中带刚","兑":"喜悦和顺，交流沟通"};if(e.name&&t[e.name])return t[e.name];if(e.upperTrigram&&e.lowerTrigram){return`上卦显示${t[e.upperTrigram]||"变化不定"}，下卦显示${t[e.lowerTrigram]||"基础不稳"}`}return"需要谨慎前行，静观其变"},f=(e,t)=>{const a=e.changingLines?.length>0?`变爻位置：${e.changingLines.join("、")}`:"无变爻";let n="";return e.lines&&e.lines.length>0&&(n=e.lines.map(e=>`第${e.position}爻：${"yang"===e.type?"阳":"阴"}${e.changing?"(变)":""}`).join("\n    ")),`作为资深的周易专家，请详细解读以下卦象：\n\n卦象信息：\n- 卦名：${e.name}\n- 卦序：第${e.number||""}卦\n- 卦象：${e.symbol}\n- 上卦：${e.upperTrigram}\n- 下卦：${e.lowerTrigram}\n- ${a}\n- 卦辞：${e.interpretation||""}\n- 爻线：\n    ${n}\n\n用户问题：${t||"请给出全面的运势分析"}\n\n${t?`请根据用户的问题"${t}"进行针对性解读`:"请从以下方面进行详细解读：\n1. 卦象总体含义和象征\n2. 事业运势分析\n3. 感情运势分析\n4. 财运状况分析\n5. 健康状况分析\n6. 学业运势分析（如适用）\n7. 近期建议和注意事项\n8. 长远发展建议"}\n\n请用通俗易懂的语言，结合现代生活实际情况进行解读，每个方面都要给出具体的建议。回答需要有条理，每个部分请用标题标明。`};return{apiKey:t,apiEndpoint:a,apiModel:s,loading:r,error:l,lastResponse:u,requestCount:c,successCount:m,failureCount:d,isConfigured:v,hasError:p,successRate:g,setApiKey:e=>!("string"!=typeof e||!e.trim())&&(t.value=e.trim(),!0),setApiEndpoint:e=>!("string"!=typeof e||!e.trim())&&(a.value=e.trim(),!0),setApiModel:e=>!("string"!=typeof e||!e.trim())&&(s.value=e.trim(),!0),interpretHexagram:async(n,i,p={})=>{const g=o("errorHandler");if(!n||!n.name)throw g&&g.handleValidationError("卦象数据不能为空"),new Error("卦象数据不能为空");if(!v.value)throw g&&g.handleValidationError("API密钥未配置"),new Error("API密钥未配置");r.value=!0,l.value=null,c.value++;const w=async()=>{const e=f(n,i),o={model:p.model||s.value,messages:[{role:"user",content:e}],temperature:p.temperature||.7,max_tokens:p.maxTokens||2e3,top_p:p.topP||.95,stream:!1},r=await k.post(a.value,o,{headers:{Authorization:`Bearer ${t.value}`,"Content-Type":"application/json"},timeout:p.timeout||6e4});if(r.data&&r.data.choices&&r.data.choices.length>0){const e=r.data.choices[0].message.content;return u.value=r.data,m.value++,e}throw new Error("API响应格式不正确")},y=()=>(d.value++,`由于AI服务暂时不可用，以下是传统解卦内容：\n      \n卦名：${n.name}\n卦象：${n.symbol||""}\n卦辞：${n.interpretation||""}\n\n此卦提示您当前形势${h(n)}。\n      \n请稍后再尝试AI解卦服务。`);try{return await(async(t,a,n={})=>e().withFallback(t,a,n))(()=>P(w,{showLoading:!1!==p.showLoading,loadingMessage:"正在获取AI解卦...",forbidClick:!0}),y,{showFallbackNotice:!0,fallbackMessage:"已切换到传统解卦",context:"AI解卦"})}catch(I){throw d.value++,l.value={message:I.message,original:I.message,code:I.response?.status||I.code,timestamp:(new Date).toISOString()},I}finally{r.value=!1}},buildPrompt:f,testConnection:async()=>{const e=o("errorHandler");if(!v.value)return e?e.handleValidationError("API密钥未配置"):l.value={message:"API密钥未配置"},!1;r.value=!0,l.value=null;try{return await P(async()=>200===(await k.post(a.value,{model:s.value,messages:[{role:"user",content:"你好"}],max_tokens:10},{headers:{Authorization:`Bearer ${t.value}`,"Content-Type":"application/json"},timeout:5e3})).status&&(e&&e.showSuccess("API连接测试成功"),!0),{showLoading:!0,loadingMessage:"测试API连接中..."})}catch(n){return l.value={message:"连接测试失败",original:n.message,code:n.response?.status||n.code},!1}finally{r.value=!1}},resetError:()=>{l.value=null},reset:()=>{l.value=null,r.value=!1,u.value=null},resetCounters:()=>{c.value=0,m.value=0,d.value=0}}}const D={class:"interpretation"},E={class:"content"},L={key:0,class:"no-hexagram"},j={key:1,class:"hexagram-result"},q={class:"hexagram-display-container"},B={class:"hexagram-meta"},R={class:"divination-time"},H={class:"divination-method"},z={key:0,class:"user-question"},O={class:"question-text"},V={class:"interpretation-container"},M={class:"action-buttons"},N=t({__name:"InterpretationView",setup(e){const t=h(),{generateChangedHexagram:i}=x(),o=T(),{getRecordById:k,updateRecord:C}=b(),P=n(!1),N=n(null),K=n(null),Q=n({}),F=n(null),J=n(null),U=n(!1),G=n(!1),W=n(null),X=n("traditional"),Y=n(!1),Z=n(!1),ee=n(""),te=n(!1),ae=[{name:"微信好友",icon:"wechat"},{name:"朋友圈",icon:"wechat-moments"},{name:"复制链接",icon:"link"},{name:"保存图片",icon:"photo-o"}];s(()=>{ne()});const ne=()=>{const e=sessionStorage.getItem("divinationResult");if(e)try{const t=JSON.parse(e);if(t&&t.hexagram){const e={id:`divination-${Date.now()}`,timestamp:(new Date).toISOString(),method:t.inputData?.method||"unknown",question:"",hexagram:t.hexagram,inputData:t.inputData,isBookmarked:!1},{saveRecord:a}=b();return a(e),localStorage.setItem("current-divination-record",e.id),Q.value=e,N.value=e.hexagram,P.value=!0,e.hexagram.changingLines&&e.hexagram.changingLines.length>0&&(K.value=i(e.hexagram)),ie(),void sessionStorage.removeItem("divinationResult")}}catch(a){}const t=localStorage.getItem("current-divination-record");if(t){const e=k(t);e&&e.hexagram&&(Q.value=e,N.value=e.hexagram,Z.value=e.isBookmarked||!1,P.value=!0,e.hexagram.changingLines&&e.hexagram.changingLines.length>0&&(K.value=i(e.hexagram)),ie(),e.aiInterpretation&&(J.value=e.aiInterpretation))}},ie=()=>{if(N.value){U.value=!0;try{a(()=>import("./gua_data-Du4v7Gm4.js"),[]).then(e=>{const t=e.default.find(e=>e.number===N.value.number);t?F.value={guaData:t,hexagram:N.value,timestamp:(new Date).toISOString()}:$("未找到对应的卦象数据")}).catch(e=>{$("加载卦象数据失败")}).finally(()=>{U.value=!1})}catch(e){$("加载解卦内容失败"),U.value=!1}}},oe=async e=>{if(N.value){G.value=!0,W.value=null;try{const e=await(async()=>{let e=localStorage.getItem("deepseek-api-key");return e||new Promise((e,t)=>{_({title:"API密钥配置",message:"请输入DeepSeek API密钥",showCancelButton:!0,confirmButtonText:"确定",cancelButtonText:"取消",className:"api-key-dialog",beforeClose:a=>"confirm"===a?new Promise(t=>{const a=document.querySelector(".api-key-dialog input"),n=a?a.value.trim():"";if(!n)return $("请输入有效的API密钥"),void t(!1);localStorage.setItem("deepseek-api-key",n),e(n),t(!0)}):(t(new Error("用户取消输入API密钥")),Promise.resolve(!0)),message:()=>w("div",[w("p","请输入DeepSeek API密钥以使用AI解卦功能"),w("input",{type:"text",placeholder:"请输入API密钥",style:"width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #dcdfe6; border-radius: 4px;"})])}).catch(e=>{t(e)})})})();o.setApiKey(e);const t=await o.interpretHexagram(N.value,Q.value.question||"请给出全面的运势分析"),a=!!Q.value.question,n=A(t,a);J.value={...n,title:`${N.value.name}卦AI解读`,subtitle:a?`问题：${Q.value.question}`:"运势分析",isCustomQuestion:a},Q.value.id&&C(Q.value.id,{aiInterpretation:J.value})}catch(t){W.value=t.message,$(t.message)}finally{G.value=!1}}},se=e=>{X.value=e},re=()=>{Y.value=!0},le=e=>{switch(Y.value=!1,e.name){case"复制链接":const t=window.location.href;navigator.clipboard.writeText(t).then(()=>{S("链接已复制")});break;case"保存图片":_({title:"保存图片",message:"是否将当前解卦结果保存为图片？",showCancelButton:!0,confirmButtonText:"确认",cancelButtonText:"取消"}).then(()=>{$("图片保存功能开发中")}).catch(()=>{});break;default:_({title:"分享到"+e.name,message:"是否将当前解卦结果分享到"+e.name+"？",showCancelButton:!0,confirmButtonText:"确认",cancelButtonText:"取消"}).then(()=>{$(`${e.name}功能开发中`)}).catch(()=>{})}},ue=()=>{t.push("/")},ce=()=>{ee.value.trim()?Q.value.id&&(C(Q.value.id,{question:ee.value.trim()}),Q.value.question=ee.value.trim(),te.value=!1,S("问题已保存")):$("问题不能为空")},me=()=>{ee.value=Q.value.question||"",te.value=!0,C(Q.value.id,{question:""}),Q.value.question=""},de=()=>{t.push("/divination")},ve=e=>{if(!e)return"";return new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})};return(e,t)=>{const a=v("van-icon"),n=v("van-nav-bar"),i=v("van-button"),o=v("van-empty"),s=v("van-tag"),h=v("van-field"),w=v("van-cell"),x=v("van-cell-group"),k=v("van-action-sheet");return f(),r("div",D,[l(n,{title:"解卦","left-text":"返回","left-arrow":"",onClickLeft:ue,fixed:""},{right:c(()=>[P.value?(f(),m(a,{key:0,name:"share-o",size:"18",onClick:re})):d("",!0)]),_:1}),u("div",E,[P.value?(f(),r("div",j,[u("div",q,[l(y,{hexagram:N.value,showChanging:!0,showInfo:!0},null,8,["hexagram"]),u("div",B,[u("div",R,[l(s,{type:"primary",size:"medium",plain:""},{default:c(()=>[p(g(ve(Q.value.timestamp)),1)]),_:1})]),u("div",H,[l(s,{type:"success",size:"medium",plain:""},{default:c(()=>[p(g("plum-blossom"===Q.value.method?"梅花易数":"铜钱卦"),1)]),_:1})])]),"ai"===X.value?(f(),r("div",z,[l(x,{inset:""},{default:c(()=>[Q.value.question?(f(),m(w,{key:1,title:"问题"},{value:c(()=>[u("div",O,g(Q.value.question),1)]),"right-icon":c(()=>[l(a,{name:"edit",onClick:me})]),_:1})):(f(),m(h,{key:0,modelValue:ee.value,"onUpdate:modelValue":t[0]||(t[0]=e=>ee.value=e),label:"您的问题",placeholder:"请输入您想咨询的问题（可选）",maxlength:"100","show-word-limit":""},{button:c(()=>[l(i,{size:"small",type:"primary",onClick:ce},{default:c(()=>t[4]||(t[4]=[p("保存",-1)])),_:1,__:[4]})]),_:1},8,["modelValue"]))]),_:1})])):d("",!0)]),u("div",V,[l(I,{traditionalInterpretation:F.value,aiInterpretation:J.value,loading:U.value,aiLoading:G.value,aiError:W.value,enableAI:!0,showTabs:!0,defaultTab:"traditional",onRequestAi:oe,onTabChange:se},null,8,["traditionalInterpretation","aiInterpretation","loading","aiLoading","aiError"])]),u("div",M,[l(i,{type:"default",icon:"arrow",size:"small",onClick:de},{default:c(()=>t[5]||(t[5]=[p(" 再次卜卦 ",-1)])),_:1,__:[5]})])])):(f(),r("div",L,[l(o,{description:"暂无卦象",image:"search"},{bottom:c(()=>[t[3]||(t[3]=u("p",{class:"empty-tip"},"请先进行卜卦，再查看解卦结果",-1)),l(i,{round:"",type:"primary",class:"bottom-button",to:"/divination"},{default:c(()=>t[2]||(t[2]=[p(" 去卜卦 ",-1)])),_:1,__:[2]})]),_:1})]))]),l(k,{show:Y.value,title:"分享解卦结果",actions:ae,onSelect:le,"cancel-text":"取消",onCancel:t[1]||(t[1]=e=>Y.value=!1)},null,8,["show"])])}}},[["__scopeId","data-v-e2755b73"]]);export{N as default};
